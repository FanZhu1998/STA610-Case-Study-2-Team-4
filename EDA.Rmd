---
title: \vspace{-1.5cm} \textbf{STA610 Case Study 2 Report}
author:
- Cole Juracek 
- Lauren Palazzo 
- Lingyu Zhou 
- Fan Zhu
date: "`r Sys.Date()`"
output:
  pdf_document: default
fontsize: 11pt
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(pacman)
pacman::p_load(tidyverse, lme4, gridExtra, grid, lattice, influence.ME, knitr, GGally, corrplot, rstan, brms, cowplot, directlabels, tidybayes)
# devtools::install_github("goodekat/redres")
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())
```

```{r, warning=FALSE, message=FALSE, error=FALSE}
VS <- read.delim("voter_stats_20201103.txt", header = TRUE)
HS <- read.delim("history_stats_20201103.txt", header = TRUE)
```

```{r}
# aggregate
VS_aggregated <- aggregate(VS$total_voters,
                             list(County=VS$county_desc,
                                  Precinct=VS$precinct_abbrv,
                                  Vtd=VS$vtd_abbrv,
                                  Age=VS$age,
                                  Party=VS$party_cd,
                                  Race=VS$race_code,
                                  Ethnic=VS$ethnic_code,
                                  Sex=VS$sex_code),sum) %>%
  rename(total_voter = x)

HS_aggregated <- aggregate(HS$total_voters,
                             list(County=HS$county_desc,
                                  Precinct=HS$precinct_abbrv,
                                  Vtd=HS$vtd_abbrv,
                                  Age=HS$age,
                                  Party=HS$party_cd,
                                  Race=HS$race_code,
                                  Ethnic=HS$ethnic_code,
                                  Sex=HS$sex_code),sum) %>%
  rename(total_voter = x)
```

```{r, include = FALSE}
# discard election_date,stats_type, and update_date. 
county_list <-  unique(HS$county_desc)

set.seed(1234)
sample_list <- sample(county_list, size=30, replace=FALSE)

VS_sampled <- VS_aggregated %>%
  filter(County %in% sample_list)

HS_sampled <- HS_aggregated %>%
  filter(County %in% sample_list)
```

```{r}
# merge 
df = full_join(VS_sampled, HS_sampled, by = c("County"="County",
                                              "Precinct"="Precinct",
                                              "Vtd"="Vtd",
                                              "Age"="Age",
                                              "Party"="Party",
                                              "Race"="Race",
                                              "Ethnic"="Ethnic",
                                              "Sex"="Sex")) %>%
  rename(total_registered_voter = total_voter.x,
         total_voted_voter = total_voter.y)
```

### Data Problems

1/2. NA's in `total_registered_voter` / `total_voted_voter`
3. `total_voted_voter` > `total_registered_voter`

1. 

```{r}
df %>% filter(is.na(total_registered_voter))
```
Only 81 - filter out:

```{r}
df <- df %>% filter(!is.na(total_registered_voter))
```

2. 

```{r}
df %>% filter(is.na(total_voted_voter))
```
This is presumably an artifact of the full join. We hypothesize that NAs exist because there are categories with registered voters that didn't vote. Because of this, we will set these to 0:

```{r}
df$total_voted_voter <- df %>% pull(total_voted_voter) %>% replace_na(0)
```

Finally, we seem to have some rows where the number of voters *exceeds* the number of registered voters. This presumably should never happen:

```{r}
df %>% filter(total_voted_voter > total_registered_voter)
```
Only 73 rows - not a huge problem. We don't see a scenario where this makes sense, and will assume error in data collection. We will remove these rows:

```{r}
df <- df %>% filter(total_voted_voter <= total_registered_voter)
```

## EDA

We are interested in viewing EDA through the following questions:

- How did different demographic subgroups vote in the 2020 general elections? For example, how did the turnout for males compare to the turnout for females after controlling for other potential predictors?
- Did the overall probability or odds of voting differ by county in 2020? Which counties differ the most from other counties?
- How did the turnout rates differ between females and males for the different party affiliations?
- How did the turnout rates differ between age groups for the different party affiliations?

First, let's check the voter turnout for the marginal categories of all subgroups:

```{r}
# Remove NA values for plotting purposes
df_plot <- df %>% filter(!is.na(total_voted_voter) & !is.na(total_registered_voter))
```

```{r}
for(var in c('County', 'Age', 'Party', 'Race', 'Ethnic', 'Sex')) {
    p <- df_plot %>% 
        group_by_at(var) %>% 
        summarise(prop=sum(total_voted_voter) / sum(total_registered_voter)) %>% 
        ggplot(aes_string(x=var, y='prop', fill=var)) + geom_col()
    plot(p)
}
```

Next, we'll investigate the interactions between party affiliation and gender / age group (research questions of interest)

```{r}
df_plot %>% 
  group_by(Sex) %>% 
  mutate(prop=sum(total_voted_voter) / sum(total_registered_voter)) %>% 
  ggplot(aes(x=Party, y=prop, fill=Sex)) + 
  geom_bar(position="fill", stat="identity")

df_plot %>% 
  group_by(Age) %>% 
  mutate(prop=sum(total_voted_voter) / sum(total_registered_voter)) %>% 
  ggplot(aes(x=Age, y=prop, fill=Party)) + 
  geom_bar(position="fill", stat="identity")
```

# Model Building

Based on the research questions of interest, we would like to include:

- Sex
- Age
- Party
- Sex + Party interaction
- Age + Party interaction
- County

Research question one also suggests different demographic subgroups, so including race and ethnic makes sense. What about the remaining variables (precinct + vtd)?

- Precinct has a very large number of levels (560), some are missing, and it's not immediately clear what a precinct is for analysis purposes. Likely ignore.
- Vtd faces the exact same problems as precinct. Ignore for now.

Thus we can propose the initial Bayesian binomial mixed effects regression model:

$$
y_{ij} | x_{ij} \sim Bin(n_i, \pi_{ij}) \\
logit(\pi_{ij}) = \beta_0 + \beta s_i + \beta A_i + \beta P_i + \beta (A_i * P_i) + \beta (A_i * S_i) + b_{0j} \\
b_{0j} \sim N(0, \tau^2) \\
p(\beta_0) \sim N(0, ?) \\
p(\beta) \sim MVN(0, ?) \\
p(\tau^2)  \sim Inv-gamma(?, ?)
$$
